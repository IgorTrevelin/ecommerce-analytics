resources:
  jobs:
    delta_lake_pipelines_job:
      name: delta_lake_pipelines_job
      max_concurrent_runs: 1
      # git_source:
      #   git_provider: github
      #   git_url: https://github.com/IgorTrevelin/ecommerce-analytics
      #   git_branch: main

      schedule:
        quartz_cron_expression: "0 0 0 * * ?"
        timezone_id: America/Sao_Paulo

      tasks:
        # customers pipeline tasks
        - task_key: bronze_customers
          job_cluster_key: delta_lake_pipelines_cluster
          notebook_task:
            notebook_path: ../bronze/ehubs_stream_ingestion.py
            base_parameters:
              catalog: dbs_data_eng
              table_name: customers
              schema_filename: customers.json
              ehubs_topic: postgres.public.customers
              primary_key: customer_id

        - task_key: silver_customers
          job_cluster_key: delta_lake_pipelines_cluster
          depends_on:
            - task_key: bronze_customers
          notebook_task:
            notebook_path: ../silver/bronze_to_silver_cdf_ingestion.py
            base_parameters:
              source_table: dbs_data_eng.bronze.customers
              target_catalog: dbs_data_eng
              target_schema: silver
              target_table: customers
              source_primary_key: customer_id
              target_primary_key: customer_id
              query_file: customers.sql

        # products pipeline tasks
        - task_key: bronze_products
          job_cluster_key: delta_lake_pipelines_cluster
          notebook_task:
            notebook_path: ../bronze/ehubs_stream_ingestion.py
            base_parameters:
              catalog: dbs_data_eng
              table_name: products
              schema_filename: products.json
              ehubs_topic: postgres.public.products
              primary_key: product_id

        - task_key: silver_products
          job_cluster_key: delta_lake_pipelines_cluster
          depends_on:
            - task_key: bronze_products
          notebook_task:
            notebook_path: ../silver/bronze_to_silver_cdf_ingestion.py
            base_parameters:
              source_table: dbs_data_eng.bronze.products
              target_catalog: dbs_data_eng
              target_schema: silver
              target_table: products
              source_primary_key: product_id
              target_primary_key: product_id
              query_file: products.sql

        # product categories pipeline tasks
        - task_key: bronze_product_categories
          job_cluster_key: delta_lake_pipelines_cluster
          notebook_task:
            notebook_path: ../bronze/ehubs_stream_ingestion.py
            base_parameters:
              catalog: dbs_data_eng
              table_name: product_categories
              schema_filename: product_categories.json
              ehubs_topic: postgres.public.product_categories
              primary_key: category_id

        - task_key: silver_product_categories
          job_cluster_key: delta_lake_pipelines_cluster
          depends_on:
            - task_key: bronze_product_categories
          notebook_task:
            notebook_path: ../silver/bronze_to_silver_cdf_ingestion.py
            base_parameters:
              source_table: dbs_data_eng.bronze.product_categories
              target_catalog: dbs_data_eng
              target_schema: silver
              target_table: product_categories
              source_primary_key: category_id
              target_primary_key: category_id
              query_file: product_categories.sql

        # sellers pipeline tasks
        - task_key: bronze_sellers
          job_cluster_key: delta_lake_pipelines_cluster
          notebook_task:
            notebook_path: ../bronze/ehubs_stream_ingestion.py
            base_parameters:
              catalog: dbs_data_eng
              table_name: sellers
              schema_filename: sellers.json
              ehubs_topic: postgres.public.sellers
              primary_key: seller_id

        - task_key: silver_sellers
          job_cluster_key: delta_lake_pipelines_cluster
          depends_on:
            - task_key: bronze_sellers
          notebook_task:
            notebook_path: ../silver/bronze_to_silver_cdf_ingestion.py
            base_parameters:
              source_table: dbs_data_eng.bronze.sellers
              target_catalog: dbs_data_eng
              target_schema: silver
              target_table: sellers
              source_primary_key: seller_id
              target_primary_key: seller_id
              query_file: sellers.sql

        # zip_code_prefixes pipeline tasks
        - task_key: bronze_zip_code_prefixes
          job_cluster_key: delta_lake_pipelines_cluster
          notebook_task:
            notebook_path: ../bronze/ehubs_stream_ingestion.py
            base_parameters:
              catalog: dbs_data_eng
              table_name: zip_code_prefixes
              schema_filename: zip_code_prefixes.json
              ehubs_topic: postgres.public.zip_code_prefixes
              primary_key: zip_code_id

        - task_key: silver_zip_code_prefixes
          job_cluster_key: delta_lake_pipelines_cluster
          depends_on:
            - task_key: bronze_zip_code_prefixes
          notebook_task:
            notebook_path: ../silver/bronze_to_silver_cdf_ingestion.py
            base_parameters:
              source_table: dbs_data_eng.bronze.zip_code_prefixes
              target_catalog: dbs_data_eng
              target_schema: silver
              target_table: zip_code_prefixes
              source_primary_key: zip_code_id
              target_primary_key: zip_code_id
              query_file: zip_code_prefixes.sql

        # orders pipeline tasks
        - task_key: bronze_orders
          job_cluster_key: delta_lake_pipelines_cluster
          notebook_task:
            notebook_path: ../bronze/ehubs_stream_ingestion.py
            base_parameters:
              catalog: dbs_data_eng
              table_name: orders
              schema_filename: orders.json
              ehubs_topic: postgres.public.orders
              primary_key: order_id

        - task_key: silver_orders
          job_cluster_key: delta_lake_pipelines_cluster
          depends_on:
            - task_key: bronze_orders
          notebook_task:
            notebook_path: ../silver/bronze_to_silver_cdf_ingestion.py
            base_parameters:
              source_table: dbs_data_eng.bronze.orders
              target_catalog: dbs_data_eng
              target_schema: silver
              target_table: orders
              source_primary_key: order_id
              target_primary_key: order_id
              query_file: orders.sql

        # order_items pipeline tasks
        - task_key: bronze_order_items
          job_cluster_key: delta_lake_pipelines_cluster
          notebook_task:
            notebook_path: ../bronze/ehubs_stream_ingestion.py
            base_parameters:
              catalog: dbs_data_eng
              table_name: order_items
              schema_filename: order_items.json
              ehubs_topic: postgres.public.order_items
              primary_key: order_id, order_item_id

        - task_key: silver_order_items
          job_cluster_key: delta_lake_pipelines_cluster
          depends_on:
            - task_key: bronze_order_items
          notebook_task:
            notebook_path: ../silver/bronze_to_silver_cdf_ingestion.py
            base_parameters:
              source_table: dbs_data_eng.bronze.order_items
              target_catalog: dbs_data_eng
              target_schema: silver
              target_table: order_items
              source_primary_key: order_id, order_item_id
              target_primary_key: order_id, order_item_id
              query_file: order_items.sql
        
        - task_key: dbt_gold_models
          job_cluster_key: delta_lake_pipelines_cluster
          depends_on:
            - task_key: silver_customers
            - task_key: silver_products
            - task_key: silver_product_categories
            - task_key: silver_sellers
            - task_key: silver_zip_code_prefixes
            - task_key: silver_orders
            - task_key: silver_order_items
          dbt_task:
            commands:
              - dbt deps
              - dbt run
            project_directory: "../../"
            profiles_directory: ""
          libraries:
            - pypi:
                package: dbt-databricks>=1.8.6,<2.0.0

      job_clusters:
        - job_cluster_key: delta_lake_pipelines_cluster
          new_cluster:
            spark_version: 14.3.x-scala2.12
            node_type_id: Standard_DS3_v2
            custom_tags:
              ResourceClass: "SingleNode"
            data_security_mode: "SINGLE_USER"
            runtime_engine: "STANDARD"
            num_workers: 1
            azure_attributes:
              first_on_demand: 1
              availability: "ON_DEMAND_AZURE"
              spot_bid_max_price: -1
            spark_conf:
              spark.databricks.cluster.profile: "singleNode"
              spark.databricks.delta.properties.defaults.enableChangeDataFeed: "true"
              spark.databricks.delta.autoCompact.enabled: "auto"
              spark.databricks.delta.optimizeWrite.enabled: "true"
